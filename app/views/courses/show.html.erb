<!DOCTYPE html>
<html lang="en">
  <head>
    <%= stylesheet_link_tag "courses" %>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= current_user.username %>'s CourseView </title>
  </head>
  
  <body>
    <header>
      <h1><%= current_user.username %>'s CourseView </h1>
      <nav>
        <ul>
          <li>Course</li>
          <li>Proposal</li>
        </ul>
      </nav>
    </header>
    
    <main>
      <section>
        <header>
          <h2>@course.course_name</h2>
        </header>
        
        <% if @project_template.present? %>
          <article>
            <h3>Proposal Guidelines</h3>
            <%= simple_format(@project_template.description) %>
          </article>
        
        <section>
          <h3>Proposal Status</h3>
          <% if @latest_instance.present? %>
            <p>Your latest submission: <%= @latest_instance.submitted_at&.strftime("%d %b %Y")</p>
            <p>Status: <%= @latest_instance.project.status.titleize %></p>
          <% else %>
            <p>You have not submitted for <%= @course.course_name %>, Please propose through supervisors.</p>
          <% end %>
        </section>
        
        <section>
          <h3>Supervisors Available</h3>
          <ul>
            <% @supervisors.each do |supervisor| %>
              <li>
                <h4><%= supervisor.username %></h4>
                <p>Last seen: yesterday</p>
                <p>Avg response time: 1 day</p>
                <p><%= supervisor.projects.where(enrolment: { course_id: @course.id }).count %>/4</p>
              </li>
            <% end %>
          </ul>
        </section>
        
        <section>
          <h3>Topics</h3>
          <ul>
            <% @topics.each do |project| %>
              <% latest_instance = project.latest_instance %>
            <li>
              <h4><%= project_instance_title(latest_instance) %></h4>
              <p><%= project.supervisor.username %></p>
              <ul>
                <li>
                  <p>Group Members: <%= project.members.map(&:username).join(", ") %></p>
                  <p>Features: <%= truncate(project_instance_description(latest_instance), length: 100) %></p>
                </li>
              </ul>
            </li>
          <% end %>
         </ul>
        </section>
        
        <section>
          <h3>Participants</h3>
          <ul>
            <% @participants.each do |user| %>
              <% enrolment = user.enrolments.find_by(course_id: @course.id) %>
              <% proj = enrolment&.project %>
            </li>
              <h4><%= user.username %></h4>
              <p>Proposal status: <%= proj&.status&.titleize || "Not submitted" %></p>
            </li>
            <% end %>
          </ul>
        </section>
      </section>
    </main>
    
    <aside>
      <nav>
        <h3>Sidebar</h3>
        <ul>
          <li><a href="#guidelines">Proposal Guidelines</a></li>
          <li><a href="#supervisors">Supervisors Available</a></li>
          <li><a href="#topics">Topics</a></li>
          <li><a href="#participants">Participants</a></li>
        </ul>
      </nav>
    </aside>
  </body>
</html>