<!DOCTYPE html>
<html lang="en">
<head>
 <%= stylesheet_link_tag "courses.css" %>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title><%= current_user.username %>'s <%= @course.course_name %> Course View</title>
</head>

<body>
 <%= render 'topbar', user: current_user, course: @course %>
 <%= render 'breadcrumb', course: @course %>
 <%= render 'sidebar', course: @course, current_user_enrolment: @current_user_enrolment %>

 <div class="main">
   <header class="course-header">
     <h1><%= @course.course_name.upcase %></h1>
     <h3>Your Course</h3>
   </header>

   <section class="proposal-guidelines" id="proposal-guidelines">
     <div class="container">
       <form>
         <h4>Project Details</h4>
         <h2 class="description-text"><%= @description || "No description available for this course." %></h2>
       </form> 
     </div>
   </section>
   
   <!-- Only show the status bar + proposal card to students -->
   <section class="proposal-status" id="proposal-status">
     <div class="status-bar-container">
       <%= render 'project_status_bar', project: @project, course: @course, enrolment: @current_user_enrolment %>
     </div>
   </section>

   <section class="supervisors-available" id="supervisors-available">
     <div class="container">
       <h4>Supervisors Available</h4>
       <ul class="supervisors">
         <%= render partial: 'lecturers', collection: @lecturers, as: :lecturer, locals: { course: @course } %>
       </ul>
     </div>
   </section>

   <!-- Role-based Topics and Proposals Sections -->
   <% if @current_user_enrolment&.coordinator? %>
     <!-- Coordinator View: My Topics, Pending Topics, Pending Proposals -->
     
     <section class="my-topics" id="my-topics">
       <div class="container">
         <header class="section-header">
           <h4>My Topics</h4>
           <div class="section-actions">
             <p class="section-description">Draft topics here. Approved topics appear in your Lecturer View (visible to students)</p>
             <%= link_to "View All Lecturer Topics", course_topics_path(@course), class: "link" %>
             <% if @current_user_enrolment&.lecturer? || @current_user_enrolment&.coordinator?  %>
               <%= link_to "Create Topics", new_course_topic_path(@course), class: "link" %>
             <% end %>
           </div>
         </header> 

         <% my_topics = @topic_list.select { |project| project.ownership.lecturer? && project.ownership.owner == current_user } %>

         <% if my_topics.empty? %>
           <p class="empty-state">You haven't created any topics yet.</p>
         <% else %>
           <% %w[pending redo rejected].each do |stat| %>
             <% group = my_topics.select { |p| p.status.to_s == stat } %>
             <% if group.any? %>
               <div class="status-group status-<%= stat %>">
                 <h5 class="status-header"><%= stat.titleize %> <%= image_tag "#{stat}.svg", class: "status-indicator-icon" %></h5>
                 <div class="cards-container">
                   <%= render partial: 'project_card', collection: group, as: :project %>
                 </div>
               </div>
             <% end %> 
           <% end %>
         <% end %>
       </div>
     </section>

     <section class="pending-topics" id="pending-topics">
       <div class="container">
         <header class="section-header">
           <h4>Pending Topics</h4>
           <p class="section-description">Lecturer-proposed topics awaiting your approval</p>
         </header>

         <% submitted_topics = @topic_list.select do |project| 
             project.ownership&.lecturer? &&
             project.ownership&.owner != current_user &&
             %w[pending redo rejected].include?(project.status.to_s)
           end %> 

         <% if submitted_topics.empty? %>
           <p class="empty-state">No Topics submmited to you.</p>
         <% else %>
           <% %w[pending redo rejected].each do |stat| %>
             <% group = submitted_topics.select { |p| p.status.to_s == stat } %>
             <% if group.any? %>
               <div class="status-group status-<%= stat %>">
                 <h5 class="status-header"> <%= stat.titleize %> <%= image_tag "#{stat}.svg", class: "status-indicator-icon" %></h5>
                 <div class="cards-container">
                   <%= render partial: 'project_card', collection: group, as: :project  %>
                 </div>
               </div>
             <% end %>
           <% end %>
         <% end %>
       </div>
     </section>

     <section class="pending-proposals" id="pending-proposals">
       <div class="container">
         <header class="section-header">
           <h4>Pending Proposals</h4>
           <p class="section-description">Student proposals awaiting your approval</p>
         </header>
         <div class="project-list-gapper">
           <div class="cards-container">
             <% pending_proposals = @course.projects.includes(:ownership)
                                           .where(status: 'pending')
                                           .joins(:ownership)
                                           .where.not(ownerships: { ownership_type: Ownership.ownership_types[:lecturer] }) %>
             <% if pending_proposals.any? %>
               <%= render partial: 'project_card', collection: pending_proposals, as: :project %>
             <% else %>
               <p class="empty-state">No student proposals are pending approval.</p>
             <% end %>
           </div>
         </div>
       </div>
     </section>

   <% elsif @current_user_enrolment&.lecturer? %>
     <!-- Lecturer View: My Topics, Pending Proposals -->
     
     <section class="my-topics" id="my-topics">
       <div class="container">
         <header class="section-header">
           <h4>My Topics</h4>
           <div class="section-actions">
             <p class="section-description">Draft topics here. Approved topics appear in your Lecturer View (visible to students)</p>
             <%= link_to "View All Lecturer Topics", course_topics_path(@course), class: "link" %>
             <% if @current_user_enrolment&.lecturer? || @current_user_enrolment&.coordinator?  %>
               <%= link_to "Create Topics", new_course_topic_path(@course), class: "link" %>
             <% end %>
           </div>
         </header>

         <% lecturer_topics = @topic_list.select { |project| 
              project.ownership&.owner == current_user && 
              project.ownership&.lecturer? 
            } %>

         <% if lecturer_topics.empty? %>
           <p class="empty-state">You haven't created any topics yet.</p>
         <% else %>
           <% %w[pending redo rejected].each do |stat| %>
             <% group = lecturer_topics.select { |p| p.status.to_s == stat } %>
             <% if group.any? %>
               <div class="status-group status-<%= stat %>">
                 <h5 class="status-header"><%= stat.titleize %> <%= image_tag "#{stat}.svg", class: "status-indicator-icon" %></h5>
                 <div class="cards-container">
                   <%= render partial: 'project_card', collection: group, as: :project %>
                 </div>
               </div>
             <% end %>
           <% end %>
         <% end %>
       </div>
     </section>

     <section class="pending-proposals" id="pending-proposals">
       <div class="container">
         <header class="section-header">
           <h4>Pending Proposals</h4>
           <p class="section-description">Student proposals assigned to you for supervision</p>
         </header>
         <div class="project-list-gapper">
           <div class="cards-container">
             <% assigned_proposals = @assigned_proposals %>
             <% if assigned_proposals.any? %>
               <%= render partial: 'project_card', collection: assigned_proposals, as: :project %>
             <% else %>
               <p class="empty-state">No proposals are assigned to you for supervision.</p>
             <% end %>
           </div>
         </div>
       </div>
     </section>

   <% else %>
     <!-- Student View: All Topics -->
     
     <section class="available-topics" id="available-topics">
       <div class="container">
         <header class="section-header">
           <h4>Available Topics</h4>
           <p class="section-description">Topics available for selection</p>
         </header>
         <div class="project-list-gapper">
           <div class="cards-container">
             <% available_topics = @topic_list.select { |project| 
                  project_viewable_by_current_user?(@course, project) 
                } %>
             <% if available_topics.any? %>
               <%= render partial: 'project_card', collection: available_topics, as: :project %>
             <% else %>
               <p class="empty-state">No topics are currently available.</p>
             <% end %>
           </div>
         </div>
       </div>
     </section>
   <% end %>
 </div>

 <%= javascript_include_tag "courses", "data-turbo-track": "reload", defer: true %>
</body>
</html>