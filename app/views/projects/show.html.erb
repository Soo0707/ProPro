<!DOCTYPE html>
<html lang="en">
 <head>
   <%= stylesheet_link_tag "projects" %>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title><%= @current_instance.title %> - Project Details</title>
 </head>
 <body>
   <% current_version = @index %>
   <% oldest_version = 1 %>
   <% latest_version = @instances.size %>
   <main id="project">
     <div class="project-layout">

       <section class="project-content">
         <%= render 'project_header',
                    current_instance: @current_instance,
                    owner: @owner,
                    type: @type,
                    project: @project,
                    members: @members,
                    current_version: current_version,
                    latest_version: latest_version,
                    oldest_version: oldest_version,
                    instances: @instances %>
         <%= render 'project_actions',
                    members: @members,
                    current_user: current_user,
                    project: @project,
                    current_version: current_version,
                    latest_version: latest_version,
                    course: @course %>

        <% if @project.ownership&.owner == current_user || @current_instance.supervisor == current_user %>           
          <%= render 'project_comments',
                      comments: @comments,
                      new_comment: @new_comment,
                      course: @course,
                      project: @project,
                      current_version: current_version,
                      latest_version: latest_version %>
        <% end %>

        <% if @course.use_progress_updates && @current_instance.status == "approved" %>
          <% if @current_instance.supervisor == current_user %>
            <%= link_to "Add Progress Update", new_course_project_progress_update_path(@course, @project) %>
          <% end %>
        <% end %>
        
        <%= render 'project_fields', fields: @fields, based_on_topic_name: @current_instance&.source_topic&.project_instances&.last&.title || nil %>

        <div class = "progress_update">

          <% total = @progress.size %>
          <% @progress.each_with_index do |progress_update, i| %>
            <div class="progress-update">
              <%= link_to "Update #{total - i}", course_project_progress_update_path(@course, @project, progress_update) %>
              <p><strong>Feedback:</strong> <%= progress_update.feedback %></p>
              <p><strong>Date:</strong> <%= progress_update.date %></p>
              <p><strong>Updated At:</strong> <%= progress_update.updated_at.strftime("%d-%m-%Y") %></p>
              <p><strong>Rating:</strong> <%= progress_update.rating %></p>
              <br>
            </div>
          <% end %>

        </div>
         <footer class="project-footer">
           <%= link_to "← Back to Projects", course_path(@course) %>
         </footer>
       </section>
     </div>
   </main>
 </body>
</html>
